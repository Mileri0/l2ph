<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>plugin_demo2.dpr; Добавление своих функций</title>
<meta name="GENERATOR" content="WinCHM">
<meta http-equiv="Content-Type" content="text/html; charset=Windows-1251">

</head>

<BODY>
<P><FONT size=2 face=Arial>&nbsp;&nbsp;<FONT size=2><FONT 
face=Arial>&nbsp;</FONT><FONT size=5><FONT color=#003f7d 
face=Arial><STRONG>plugin_demo.dpr; добавление своих 
функций.</STRONG></FONT><FONT size=3> 
<P><FONT face=Arial></FONT>
<P><FONT face=Arial></FONT>
<P><FONT face=Arial></FONT>
<P><FONT face=Arial></FONT>
<P><FONT face=Arial></FONT>
<P><FONT face=Arial></FONT>
<P><FONT face=Arial></FONT>
<P><FONT face=Arial>
<P>
<P>
<P>
<P>
<HR>
<STRONG><FONT size=2>
<P><FONT size=2><STRONG>library</STRONG> plugin_demo2;<BR><BR><SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">{$define RELEASE}</SPAN> <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// для совместимости с релизом 
пакетхака, при дебуге можно закоментировать</SPAN><BR><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">uses</SPAN><BR>&nbsp; FastMM4 
<SPAN style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">in</SPAN> <SPAN 
style="COLOR: rgb(0,0,240)">'..\fastmm\FastMM4.pas'</SPAN>,<BR>&nbsp; 
FastMM4Messages <SPAN style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">in</SPAN> 
<SPAN 
style="COLOR: rgb(0,0,240)">'..\fastmm\FastMM4Messages.pas'</SPAN>,<BR>&nbsp; 
windows,<BR><BR>&nbsp; <SPAN style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// 
модуль с описаниями основных типов</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// используемых в плагине и 
программе</SPAN><BR>&nbsp; usharedstructs <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">in</SPAN> <SPAN 
style="COLOR: rgb(0,0,240)">'..\units\usharedstructs.pas'</SPAN>;<BR><BR><BR><BR><BR><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">var</SPAN><BR>&nbsp; min_ver_a: 
array[<SPAN style="COLOR: rgb(0,0,240)">0</SPAN>..<SPAN 
style="COLOR: rgb(0,0,240)">3</SPAN>] <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">of</SPAN> <SPAN 
style="COLOR: rgb(0,0,0)">Byte</SPAN> = <SPAN style="COLOR: rgb(0,0,0)">(</SPAN> 
<SPAN style="COLOR: rgb(0,0,240)">3</SPAN>,<SPAN 
style="COLOR: rgb(0,0,240)">5</SPAN>,<SPAN 
style="COLOR: rgb(0,0,240)">23</SPAN>,&nbsp; &nbsp; &nbsp; <SPAN 
style="COLOR: rgb(0,0,240)">141</SPAN>&nbsp; &nbsp;<SPAN 
style="COLOR: rgb(0,0,0)">)</SPAN>;<BR>&nbsp; min_ver: <SPAN 
style="COLOR: rgb(0,0,0)">LongWord</SPAN> absolute min_ver_a; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// минимальная поддерживаемая 
версия программы</SPAN><BR>&nbsp; ps: TPluginStruct; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// структура передаваемая в 
плагин</SPAN><BR><BR><SPAN style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// 
Обязательно вызываемая функция.</SPAN><BR><SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// Должна вернуть описание 
плагина,</SPAN><BR><SPAN style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// 
заодно может проверить версию программы</SPAN><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">function</SPAN> 
GetPluginInfo<SPAN style="COLOR: rgb(0,0,0)">(</SPAN><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">const</SPAN> ver: <SPAN 
style="COLOR: rgb(0,0,0)">LongWord</SPAN><SPAN 
style="COLOR: rgb(0,0,0)">)</SPAN>: <SPAN 
style="COLOR: rgb(0,0,0)">PChar</SPAN>; stdcall;<BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">begin</SPAN><BR>&nbsp; <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">if</SPAN> ver&lt;min_ver <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">then</SPAN><BR>&nbsp; &nbsp; 
Result:=<SPAN style="COLOR: rgb(0,0,240)">'Демонстрационный Plugin к программе 
l2phx'</SPAN>+sLineBreak+<BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <SPAN 
style="COLOR: rgb(0,0,240)">'Для версий 
3.5.23.141+'</SPAN>+sLineBreak+<BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<SPAN style="COLOR: rgb(0,0,240)">'У вас старая версия программы! Плагин не 
сможет корректно с ней работать!'</SPAN><BR>&nbsp; <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">else</SPAN><BR>&nbsp; &nbsp; 
Result:=<SPAN style="COLOR: rgb(0,0,240)">'Демонстрационный Plugin к программе 
l2phx'</SPAN>+sLineBreak+<BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <SPAN 
style="COLOR: rgb(0,0,240)">'Для версий 
3.5.23.141+'</SPAN>+sLineBreak+<BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<SPAN style="COLOR: rgb(0,0,240)">'Показывает каким образом можно добавить свою 
функцию/процедуру в ПХ'</SPAN>+sLineBreak+<BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; <SPAN style="COLOR: rgb(0,0,240)">''</SPAN>;<BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">end</SPAN>;<BR><BR><SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// Обязательно вызываемая 
функция.</SPAN><BR><SPAN style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// 
Получает структуру с ссылками на все функции основной программы,</SPAN><BR><SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// которые могут вызываться из 
плагина.</SPAN><BR><SPAN style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// Если 
вернёт False то плагин выгружается.</SPAN><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">function</SPAN> SetStruct<SPAN 
style="COLOR: rgb(0,0,0)">(</SPAN><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">const</SPAN> struct: 
PPluginStruct<SPAN style="COLOR: rgb(0,0,0)">)</SPAN>: <SPAN 
style="COLOR: rgb(0,0,0)">Boolean</SPAN>; stdcall;<BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">begin</SPAN><BR>&nbsp; ps := 
struct^;<BR>&nbsp; Result:=<SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">True</SPAN>;<BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">end</SPAN>;<BR><BR><BR><SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// Необязательно вызываемая 
функция. (может отсутствовать в плагине)</SPAN><BR><SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// Вызывается при вызове 
скриптовой функции обьявленной в RefreshPrecompile</SPAN><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">function</SPAN> OnCallMethod<SPAN 
style="COLOR: rgb(0,0,0)">(</SPAN><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">const</SPAN> ConnectId, ScriptId: 
<SPAN style="COLOR: rgb(0,0,0)">integer</SPAN>;<BR>&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">const</SPAN> MethodName: <SPAN 
style="COLOR: rgb(0,0,0)">String</SPAN>; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// имя функции в верхнем 
регистре</SPAN><BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">var</SPAN> Params, <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// параметры 
функции</SPAN><BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; FuncResult: <SPAN style="COLOR: rgb(0,0,0)">Variant</SPAN> <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// результат 
функции</SPAN><BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<SPAN 
style="COLOR: rgb(0,0,0)">)</SPAN>: <SPAN 
style="COLOR: rgb(0,0,0)">Boolean</SPAN>; stdcall; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// если вернёт True то 
дальнейшая</SPAN><BR>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// обработка функции 
прекратиться</SPAN><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">begin</SPAN><BR>&nbsp; 
Result:=<SPAN style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">False</SPAN>; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// передаём обработку функции 
программе</SPAN><BR>&nbsp; <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">if</SPAN> MethodName=<SPAN 
style="COLOR: rgb(0,0,240)">'PI'</SPAN> <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">then</SPAN> <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">begin</SPAN><BR>&nbsp; &nbsp; 
Result:=<SPAN style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">True</SPAN>; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// запрещаем дальнейшую 
обработку функции в программе</SPAN><BR>&nbsp; &nbsp; FuncResult:=<SPAN 
style="COLOR: rgb(0,0,0)">Pi</SPAN>;<BR>&nbsp; <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">end</SPAN>;<BR><BR>&nbsp; <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">if</SPAN> MethodName=<SPAN 
style="COLOR: rgb(0,0,240)">'SHOW_MY_MESSAGE'</SPAN> <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">then</SPAN> <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">begin</SPAN><BR>&nbsp; &nbsp; 
MessageBox<SPAN style="COLOR: rgb(0,0,0)">(</SPAN><SPAN 
style="COLOR: rgb(0,0,240)">0</SPAN>,<SPAN 
style="COLOR: rgb(0,0,0)">pchar</SPAN><SPAN 
style="COLOR: rgb(0,0,0)">(</SPAN><SPAN 
style="COLOR: rgb(0,0,0)">string</SPAN><SPAN 
style="COLOR: rgb(0,0,0)">(</SPAN>Params[<SPAN 
style="COLOR: rgb(0,0,240)">0</SPAN>]<SPAN 
style="COLOR: rgb(0,0,0)">)</SPAN><SPAN style="COLOR: rgb(0,0,0)">)</SPAN>,<SPAN 
style="COLOR: rgb(0,0,240)">''</SPAN>,MB_OK<SPAN 
style="COLOR: rgb(0,0,0)">)</SPAN>;<BR>&nbsp; &nbsp; Result:=<SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">True</SPAN>; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// запрещаем дальнейшую 
обработку функции в программе</SPAN><BR>&nbsp; &nbsp; FuncResult:=<SPAN 
style="COLOR: rgb(0,0,240)">0</SPAN>; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//какой результат ? это 
процедура.</SPAN><BR>&nbsp; <SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">end</SPAN>;<BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">end</SPAN>;</FONT></P>
<P><FONT size=2><SPAN style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// 
Необязательно вызываемая функция. (может отсутствовать в 
плагине)</SPAN><BR><SPAN style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// 
Вызывается после иницализации плагина, позволяет добавлять свои функции в 
редактор / скриптовый движек</SPAN><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">Procedure</SPAN> 
OnRefreshPrecompile; stdcall;<BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">begin</SPAN><BR>&nbsp; ps.<SPAN 
style="COLOR: rgb(0,0,0)">UserFuncs</SPAN>.<SPAN 
style="COLOR: rgb(0,0,0)">Add</SPAN><SPAN 
style="COLOR: rgb(0,0,0)">(</SPAN><SPAN style="COLOR: rgb(0,0,240)">'function 
Pi:Extended'</SPAN><SPAN style="COLOR: rgb(0,0,0)">)</SPAN>;<BR>&nbsp; ps.<SPAN 
style="COLOR: rgb(0,0,0)">UserFuncs</SPAN>.<SPAN 
style="COLOR: rgb(0,0,0)">Add</SPAN><SPAN 
style="COLOR: rgb(0,0,0)">(</SPAN><SPAN style="COLOR: rgb(0,0,240)">'procedure 
Show_my_message(msg:string)'</SPAN><SPAN 
style="COLOR: rgb(0,0,0)">)</SPAN>;<BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//а вот теперь 
внимание</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//ps.UserFuncs.Add('procedure 
Show_my_message(%s)');</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//%s говорит о том что функция в 
своих параметрах будет передавать изначально</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//екземпляр класса 
TfsScript</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//%s должен быть последней либо 
единственным параметром</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//к примеру обьявление некоторых 
функций в пх</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//'procedure 
SetName(Name:string;%s)'</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//'procedure 
Disconnect(%s)'</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//'procedure 
WriteS(v:string;%s)'</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//обратите внимание на ";" перед 
параметром, он есть при условии что %s не единственный параметр 
функции</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//что это дает:</SPAN><BR>&nbsp; 
<SPAN style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//возможность выдергивать 
переменные с фастскрипта.</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//как это делаеться в 
пх:</SPAN><BR>&nbsp; </FONT><FONT size=2><SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">{<BR>&nbsp; if sMethodName = 
'DISCONNECT' then<BR>&nbsp; begin<BR>&nbsp; &nbsp; 
ConId:=TfsScript(Integer(Params[0])).Variables['ConnectID'];<BR>&nbsp; &nbsp; 
DoDisconnect(ConId);<BR>&nbsp; end<BR><BR>&nbsp; либо<BR><BR>&nbsp; if 
sMethodName = 'SETNAME' then<BR>&nbsp; begin<BR>&nbsp; &nbsp; 
buf:=TfsScript(Integer(Params[1])).Variables['buf'];<BR>&nbsp; &nbsp; 
ConId:=TfsScript(Integer(Params[1])).Variables['ConnectID'];<BR>&nbsp; &nbsp; 
SetConName(ConId, String(Params[0]));<BR>&nbsp; end&nbsp; <BR>&nbsp; 
}</SPAN><BR>&nbsp; <SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">//TfsScript(Integer(Params[0])) 
- екземпляр TfsScript</SPAN><BR><BR><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">end</SPAN>;<BR><BR><BR><SPAN 
style="FONT-STYLE: italic; COLOR: rgb(0,128,0)">// экспортируем используемые 
программой функции</SPAN><BR>exports<BR>&nbsp; GetPluginInfo,<BR>&nbsp; 
SetStruct,<BR>&nbsp; OnCallMethod,<BR>&nbsp; OnRefreshPrecompile;<BR><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">begin</SPAN><BR><SPAN 
style="COLOR: rgb(0,0,128); FONT-WEIGHT: bold">end</SPAN>.</FONT></FONT></STRONG></FONT></FONT></FONT></FONT></FONT></P></BODY>
</html>
